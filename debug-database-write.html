<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“å†™å…¥è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .solution-step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
        }
        .solution-step h4 {
            margin-top: 0;
            color: #007bff;
        }
        .code-block {
            background: #f1f3f4;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ•°æ®åº“å†™å…¥è°ƒè¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­ä¸ºä»€ä¹ˆæ”¯ä»˜æˆåŠŸåæ•°æ®æ²¡æœ‰å†™å…¥æ•°æ®åº“ã€‚</p>
        
        <div class="test-section">
            <h3>1. ç¯å¢ƒå˜é‡æ£€æŸ¥</h3>
            <button onclick="checkEnvironmentVariables()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
            <div id="envResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. ç”¨æˆ·è®¤è¯çŠ¶æ€</h3>
            <button onclick="checkUserAuth()">æ£€æŸ¥ç”¨æˆ·è®¤è¯</button>
            <div id="authResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
            <button onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
            <div id="dbResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Webhook é…ç½®æ£€æŸ¥</h3>
            <button onclick="checkWebhookConfig()">æ£€æŸ¥ Webhook é…ç½®</button>
            <div id="webhookResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. æ¨¡æ‹Ÿæ”¯ä»˜å®Œæˆå¤„ç†</h3>
            <button onclick="simulatePaymentCompletion()">æ¨¡æ‹Ÿæ”¯ä»˜å®Œæˆ</button>
            <div id="paymentResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ</h3>
            <div class="solution-step">
                <h4>å¯èƒ½çš„é—®é¢˜åŸå› ï¼š</h4>
                <ol>
                    <li><strong>Webhook æœªé…ç½®</strong>ï¼šStripe webhook æ²¡æœ‰æ­£ç¡®è®¾ç½®</li>
                    <li><strong>ç¯å¢ƒå˜é‡ç¼ºå¤±</strong>ï¼šSTRIPE_WEBHOOK_SECRET æœªè®¾ç½®</li>
                    <li><strong>Webhook URL é”™è¯¯</strong>ï¼šStripe æ— æ³•è®¿é—® webhook ç«¯ç‚¹</li>
                    <li><strong>æ•°æ®åº“æƒé™é—®é¢˜</strong>ï¼šSupabase æƒé™é…ç½®ä¸æ­£ç¡®</li>
                    <li><strong>äº‹ä»¶ç±»å‹ä¸åŒ¹é…</strong>ï¼šWebhook ç›‘å¬çš„äº‹ä»¶ç±»å‹ä¸æ­£ç¡®</li>
                </ol>
            </div>

            <div class="solution-step">
                <h4>è§£å†³æ–¹æ¡ˆ 1: æ£€æŸ¥ Webhook é…ç½®</h4>
                <div class="code-block">
                    1. è®¿é—® <a href="https://dashboard.stripe.com/webhooks" target="_blank">Stripe Webhooks è®¾ç½®</a><br>
                    2. æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®çš„ webhook<br>
                    3. ç¡®è®¤ webhook URL: https://yourdomain.com/api/webhook<br>
                    4. ç¡®è®¤ç›‘å¬çš„äº‹ä»¶: invoice.paid, customer.subscription.updated<br>
                    5. æ£€æŸ¥ webhook å¯†é’¥æ˜¯å¦æ­£ç¡®
                </div>
            </div>

            <div class="solution-step">
                <h4>è§£å†³æ–¹æ¡ˆ 2: æœ¬åœ°å¼€å‘ Webhook æµ‹è¯•</h4>
                <div class="code-block">
                    1. å®‰è£… Stripe CLI: <a href="https://stripe.com/docs/stripe-cli" target="_blank">https://stripe.com/docs/stripe-cli</a><br>
                    2. ç™»å½•: stripe login<br>
                    3. è½¬å‘ webhook: stripe listen --forward-to localhost:3000/api/webhook<br>
                    4. å¤åˆ¶ webhook å¯†é’¥åˆ° .env.local<br>
                    5. æµ‹è¯•æ”¯ä»˜æµç¨‹
                </div>
            </div>

            <div class="solution-step">
                <h4>è§£å†³æ–¹æ¡ˆ 3: æ‰‹åŠ¨å¤„ç†æ”¯ä»˜å®Œæˆ</h4>
                <div class="code-block">
                    åœ¨ success é¡µé¢æ·»åŠ æ”¯ä»˜éªŒè¯é€»è¾‘ï¼š<br>
                    1. éªŒè¯ Stripe session<br>
                    2. è·å–è®¢é˜…ä¿¡æ¯<br>
                    3. ç›´æ¥æ›´æ–°æ•°æ®åº“<br>
                    4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
                </div>
            </div>
        </div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function checkEnvironmentVariables() {
            let results = [];
            
            try {
                // æ£€æŸ¥ API ç«¯ç‚¹æ˜¯å¦å¯è®¿é—®
                const response = await fetch('/api/create-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planType: 'basic' })
                });
                
                if (response.status === 401) {
                    results.push('âœ… API ç«¯ç‚¹å¯è®¿é—®ï¼ˆéœ€è¦è®¤è¯ï¼‰');
                } else if (response.ok) {
                    results.push('âœ… API ç«¯ç‚¹å¯è®¿é—®');
                } else {
                    results.push(`âš ï¸ API å“åº”å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                results.push(`âŒ API è¿æ¥å¤±è´¥: ${error.message}`);
            }

            results.push('\nç¯å¢ƒå˜é‡æ£€æŸ¥:');
            results.push('æ³¨æ„: æ— æ³•ç›´æ¥æ£€æŸ¥æœåŠ¡å™¨ç«¯ç¯å¢ƒå˜é‡');
            results.push('è¯·ç¡®ä¿ä»¥ä¸‹å˜é‡å·²è®¾ç½®:');
            results.push('- STRIPE_WEBHOOK_SECRET');
            results.push('- NEXT_PUBLIC_APP_URL');
            results.push('- STRIPE_SECRET_KEY');
            results.push('- NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY');

            showResult('envResult', results.join('\n'), 'info');
        }

        async function checkUserAuth() {
            let results = [];
            
            try {
                // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
                const response = await fetch('/api/create-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planType: 'basic' })
                });
                
                if (response.status === 401) {
                    results.push('âš ï¸ ç”¨æˆ·æœªè®¤è¯');
                    results.push('è¯·å…ˆç™»å½•æ‰èƒ½æµ‹è¯•æ”¯ä»˜æµç¨‹');
                } else if (response.ok) {
                    results.push('âœ… ç”¨æˆ·å·²è®¤è¯');
                    results.push('å¯ä»¥æµ‹è¯•æ”¯ä»˜æµç¨‹');
                } else {
                    results.push(`âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                results.push(`âŒ è®¤è¯æ£€æŸ¥é”™è¯¯: ${error.message}`);
            }

            showResult('authResult', results.join('\n'), 'info');
        }

        async function testDatabaseConnection() {
            let results = [];
            
            try {
                // æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆé€šè¿‡ APIï¼‰
                const response = await fetch('/api/create-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planType: 'basic' })
                });
                
                if (response.status === 401) {
                    results.push('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼ˆéœ€è¦è®¤è¯ï¼‰');
                    results.push('API èƒ½å¤Ÿè®¿é—® Supabase');
                } else if (response.ok) {
                    results.push('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
                    results.push('API èƒ½å¤Ÿè®¿é—® Supabase');
                } else {
                    results.push(`âš ï¸ æ•°æ®åº“è¿æ¥å¯èƒ½æœ‰é—®é¢˜: ${response.status}`);
                }
            } catch (error) {
                results.push(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`);
            }

            results.push('\næ•°æ®åº“è¡¨æ£€æŸ¥:');
            results.push('è¯·ç¡®è®¤ä»¥ä¸‹è¡¨å­˜åœ¨:');
            results.push('- users (ç”¨æˆ·è¡¨)');
            results.push('- subscriptions (è®¢é˜…è¡¨)');
            results.push('- add_credits å‡½æ•°å·²åˆ›å»º');

            showResult('dbResult', results.join('\n'), 'info');
        }

        async function checkWebhookConfig() {
            let results = [];
            
            try {
                // æµ‹è¯• webhook ç«¯ç‚¹
                const response = await fetch('/api/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.status === 400) {
                    results.push('âœ… Webhook ç«¯ç‚¹å­˜åœ¨');
                    results.push('âš ï¸ éœ€è¦æ­£ç¡®çš„ Stripe ç­¾å');
                } else if (response.ok) {
                    results.push('âœ… Webhook ç«¯ç‚¹æ­£å¸¸');
                } else {
                    results.push(`âš ï¸ Webhook ç«¯ç‚¹å“åº”å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                results.push(`âŒ Webhook ç«¯ç‚¹ä¸å¯è®¿é—®: ${error.message}`);
            }

            results.push('\nWebhook é…ç½®æ£€æŸ¥:');
            results.push('1. æ£€æŸ¥ Stripe Dashboard ä¸­çš„ webhook é…ç½®');
            results.push('2. ç¡®è®¤ webhook URL æ­£ç¡®');
            results.push('3. ç¡®è®¤ç›‘å¬çš„äº‹ä»¶ç±»å‹');
            results.push('4. æ£€æŸ¥ webhook å¯†é’¥');

            showResult('webhookResult', results.join('\n'), 'info');
        }

        async function simulatePaymentCompletion() {
            let results = [];
            
            try {
                results.push('æ¨¡æ‹Ÿæ”¯ä»˜å®Œæˆå¤„ç†:');
                results.push('1. æ£€æŸ¥ Stripe session éªŒè¯');
                results.push('2. è·å–è®¢é˜…ä¿¡æ¯');
                results.push('3. æ›´æ–°ç”¨æˆ·ç§¯åˆ†');
                results.push('4. ä¿å­˜è®¢é˜…è®°å½•');
                
                results.push('\nå»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ:');
                results.push('åœ¨ success é¡µé¢æ·»åŠ ä»¥ä¸‹é€»è¾‘:');
                results.push('1. éªŒè¯ Stripe session');
                results.push('2. è·å–è®¢é˜…è¯¦æƒ…');
                results.push('3. ç›´æ¥æ›´æ–°æ•°æ®åº“');
                results.push('4. æ˜¾ç¤ºæ›´æ–°ç»“æœ');
                
            } catch (error) {
                results.push(`âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`);
            }

            showResult('paymentResult', results.join('\n'), 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            checkEnvironmentVariables();
            checkUserAuth();
            testDatabaseConnection();
            checkWebhookConfig();
            simulatePaymentCompletion();
        });
    </script>
</body>
</html>
